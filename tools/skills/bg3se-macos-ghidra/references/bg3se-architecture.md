# Windows BG3SE Architecture Reference

Reference implementation at `/Users/tomdimino/Desktop/Programming/bg3se`

## Table of Contents
- [Project Structure](#project-structure)
- [Three-Tier Architecture](#three-tier-architecture)
- [Lua Binding System](#lua-binding-system)
- [Hooking Mechanism](#hooking-mechanism)
- [Property Map System](#property-map-system)
- [Entity Component System](#entity-component-system)
- [Osiris Integration](#osiris-integration)
- [Extension States](#extension-states)
- [Key Directories](#key-directories)

## Project Structure

```
bg3se/
├── BG3Extender/        # Main extender source
│   ├── Lua/            # Lua binding system (16 subdirectories)
│   ├── GameDefinitions/# Game engine structures (68 subdirectories)
│   ├── GameHooks/      # Engine function hooking
│   ├── Extender/       # Client/Server extension states
│   ├── Osiris/         # Osiris scripting integration
│   └── LuaDebugger/    # Debugging support
├── CoreLib/            # Foundation utilities and wrappers
└── Docs/               # API documentation
```

Total: ~333 C++ files

## Three-Tier Architecture

```
┌─────────────────────────────────┐
│   Lua Scripting Layer           │
│   (Mod Scripts → Lua VM)        │
└──────────────┬──────────────────┘
               │
┌──────────────▼──────────────────┐
│   Extension Layer               │
│   (Client/Server States)        │
└──────────────┬──────────────────┘
               │
┌──────────────▼──────────────────┐
│   Game Engine Hooks             │
│   (Detours → Engine Functions)  │
└─────────────────────────────────┘
```

## Lua Binding System

**Location:** `BG3Extender/Lua/LuaBinding.h`

### State Class (Lines 126-356)

Manages Lua VM lifecycle with:
- Separate Server & Client states
- Restriction flags system
- Lifetime management for objects

### Key Subsystems
- **LifetimeStack** - Object lifetime tracking
- **CppMetatableManager** - C++ object metadata
- **GlobalRefManager** - Reference management
- **CachedUserVariableManager** - User variable persistence
- **TimerSystem** - Event scheduling

### Memory Pattern for Lua Objects

**Location:** `BG3Extender/Lua/Shared/LuaCustomizations.inl` (Lines 44-150)

Lightweight object format uses bit-packing:
```
48-bit pointer + 16-bit lifetime (light objects)
vs
Full pointer for heavy objects (LUA_TCPPOBJECT)
```

## Hooking Mechanism

**Location:** `CoreLib/Wrappers.h`

Uses Microsoft Detours library:

```cpp
template <typename R, typename... Params>
class WrappedFunction<R(Params...)>
{
    bool IsWrapped() const;
    void Wrap(void* Function, FuncType NewFunction);
    void Unwrap();
    R operator()(Params... Args) const;
};
```

### Engine Hooks

**Location:** `BG3Extender/GameHooks/EngineHooks.inl`

Key hooked functions:
- `RPGStats__Load` - Stats loading
- `ecs__EntityWorld__Update` - ECS tick
- `stats__DealDamageFunctor__ApplyDamage` - Damage calculation
- `esv__ExecuteStatsFunctor_*` - Stat functor contexts
- `eoc__AiGrid__FindPath` - Pathfinding

## Property Map System

**Location:** `BG3Extender/Lua/Shared/Proxies/LuaPropertyMap.h`

```cpp
struct RawPropertyAccessors {
    using Getter = PropertyOperationResult(lua_State*, LifetimeHandle,
                                          void const*, RawPropertyAccessorsHotData const&);
    using Setter = PropertyOperationResult(lua_State*, void*, int,
                                          RawPropertyAccessorsHotData const&);
    FixedString Name;
    std::size_t Offset;      // Memory offset in object
    uint64_t Flag;           // Bitfield flags
    Getter* Get;
    Setter* Set;
};
```

Property maps generated by: `BG3Extender/make_property_map.py`

Property map files in: `BG3Extender/GameDefinitions/PropertyMaps/`
- ClientObjects.inl
- ServerObjects.inl
- Stats.inl
- IMGUI.inl
- UI.inl

## Entity Component System

### EntityHandle (64-bit packed)
- **Bits 0-31**: Entity Index
- **Bits 32-47**: Salt (generation counter)
- **Bits 48-63**: Type Index (archetype)

### Three Object Representation Models

1. **Light C++ Objects** - Most common
   - 48-bit pointer + 16-bit lifetime handle
   - Scoped to Lua function execution

2. **Heavy C++ Objects** - For copied values
   - Full 64-bit pointer to GC-managed object
   - Lua garbage collects the object

3. **Entity Handles** - Special case
   - 64-bit EntityHandle with type+index+salt
   - Component-based system (ECS)

### Lifetime Management

**Location:** `BG3Extender/Lua/Shared/LuaLifetime.h`

Uses hierarchical pool allocator:
- 4-level bitmap structure for O(1) allocation
- Reserved lifetime #0 for null references
- Prevents use-after-free crashes

## Osiris Integration

**Location:** `BG3Extender/GameHooks/OsirisWrappers.h`

```cpp
class OsirisWrappers {
    WRAPPABLE(bool(uint32_t FunctionHandle, OsiArgumentDesc*), Call);
    WRAPPABLE(bool(uint32_t FunctionHandle, OsiArgumentDesc*), Query);
    WRAPPABLE(void(char const*), Error);

    NodeVMT* VMTs[(unsigned)NodeType::Max + 1];
};
```

### Listener System

**Location:** `BG3Extender/Lua/Server/LuaServer.cpp` (Lines 57-79)

Supports before/after triggers on:
- Events
- Built-in calls/queries
- User-defined PROCs
- Database operations

## Extension States

**Location:** `BG3Extender/Extender/Shared/ExtensionState.h`

```
ScriptExtender (singleton)
├── esv::ScriptExtender (Server)
│   └── esv::ExtensionState
│       └── lua::State (server VM)
└── ecl::ScriptExtender (Client)
    └── ecl::ExtensionState
        └── lua::State (client VM)
```

### State Contexts
- `Uninitialized` - Not ready
- `Game` - Normal gameplay
- `Load` - Module/stats loading

### Thread Safety
- ThreadedExtenderState manages task queue
- EnqueueTask/SubmitTaskAndWait for thread-safe operations

## Key Directories

| Directory | Purpose |
|-----------|---------|
| `BG3Extender/Osiris/` | Osiris binding patterns, function lookups |
| `BG3Extender/Lua/` | Lua API design, Ext.* implementations |
| `BG3Extender/Lua/Libs/Entity.inl` | Entity Lua bindings (UuidToHandle, GetComponent) |
| `BG3Extender/GameDefinitions/` | Entity/component structures, type definitions |
| `BG3Extender/GameDefinitions/EntitySystem.cpp` | EntitySystemHelpers, GetSingleton |
| `BG3Extender/GameDefinitions/Components/Components.h` | Component struct definitions |
| `CoreLib/` | Core utilities, memory patterns |

## API Surface

### Core Modules
1. **Entity/Component System**
   - `Ext.Entity.Get(guid)` - Get entity by GUID
   - Component access/creation
   - Component replication

2. **Stats System**
   - `Ext.Stats.Get(name)` - Get stat entry
   - `Ext.Stats.Create()` - Create new stats
   - Property read/write with validation

3. **Osiris Integration**
   - `Osi.*` functions - Call Osiris from Lua
   - `Ext.Osiris.RegisterListener()` - Hook Osiris events
   - Database operations (Get, Delete, Insert)

4. **Networking**
   - `Net.CreateChannel()` - Create communication channel
   - `RequestToServer()` / `RequestToClient()`

5. **Events**
   - `Ext.Events.SessionLoaded`
   - `Ext.Events.Tick`
   - `Ext.Events.GameStateChanged`

6. **User Variables**
   - `Ext.Vars.RegisterUserVariable()`
   - Per-entity custom properties
   - Automatic syncing and persistence
